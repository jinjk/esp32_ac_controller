<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ESP32-S3 AC Controller - Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .navbar { background: rgba(255,255,255,0.1); padding: 15px 0; margin-bottom: 20px; backdrop-filter: blur(10px); }
        .nav-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .logo { color: white; font-size: 24px; font-weight: bold; text-decoration: none; }
        .nav-links { display: flex; gap: 20px; }
        .nav-links a { color: white; text-decoration: none; padding: 10px 20px; border-radius: 25px; transition: all 0.3s; }
        .nav-links a:hover, .nav-links a.active { background: rgba(255,255,255,0.2); }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .status-card { background: linear-gradient(135deg, #e3ffe7 0%, #d9e7ff 100%); border-left: 5px solid #007bff; }
        .metric { text-align: center; margin: 10px 0; }
        .metric-value { font-size: 2.5em; font-weight: bold; color: #007bff; margin: 0; }
        .metric-label { color: #666; margin: 5px 0; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; margin: 5px; }
        .btn-primary { background: linear-gradient(135deg, #007bff, #0056b3); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #6c757d, #545b62); color: white; }
        .btn-success { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; }
        .btn-warning { background: linear-gradient(135deg, #ffc107, #e0a800); color: #212529; }
        .btn-danger { background: linear-gradient(135deg, #dc3545, #bd2130); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .quick-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-on { background-color: #28a745; }
        .status-off { background-color: #dc3545; }
        .status-auto { background-color: #ffc107; }
        @media (max-width: 768px) { 
            .nav-links { display: none; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="logo">[TEMP] AC Controller</a>
            <div class="nav-links">
                <a href="/" class="active">[INFO] Dashboard</a>
                <a href="/rules.html">[RULES] Rules</a>
                <a href="/control.html">[AC] Manual Control</a>
                <a href="/settings.html">[SETTINGS] Settings</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Dashboard Cards -->
        <div class="dashboard-grid">
            <!-- Current Status Card -->
            <div class="card status-card">
                <h3>[INFO] Current Status</h3>
                <div class="metric">
                    <div class="metric-value" id="temp-display">--.-°C</div>
                    <div class="metric-label">Current Temperature</div>
                </div>
                <div style="margin-top: 20px;">
                    <p><span class="status-indicator" id="ac-indicator"></span><strong>AC Status:</strong> <span id="ac-status-text">Loading...</span></p>
                    <p><strong>[TIME] Current Time:</strong> <span id="current-time">Loading...</span></p>
                    <p><strong>[RULES] Active Rule:</strong> <span id="active-rule-name">None</span></p>
                </div>
            </div>

            <!-- Quick Controls Card -->
            <div class="card">
                <h3>[AC] Quick Controls</h3>
                <div class="quick-controls">
                    <button class="btn btn-primary" onclick="sendACCommand('power_on')">[ON] Power ON</button>
                    <button class="btn btn-secondary" onclick="sendACCommand('power_off')">[OFF] Power OFF</button>
                    <button class="btn btn-warning" onclick="sendACCommand('temp_up')">[HOT] Temp UP</button>
                    <button class="btn btn-warning" onclick="sendACCommand('temp_down')">[COLD] Temp DOWN</button>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="/control.html" class="btn btn-success">[AC] Full Control Panel</a>
                </div>
            </div>

            <!-- System Info Card -->
            <div class="card">
                <h3>[SYSTEM] System Information</h3>
                <div style="font-size: 0.9em; color: #666;">
                    <p><strong>IP Address:</strong> <span id="ip-address">Loading...</span></p>
                    <p><strong>Free Memory:</strong> <span id="free-memory">Loading...</span></p>
                    <p><strong>Uptime:</strong> <span id="uptime">Loading...</span></p>
                    <p><strong>Active Tasks:</strong> <span id="active-tasks">Loading...</span></p>
                    <p><strong>IR System:</strong> <span style="color: #28a745;">[OK] Ready</span></p>
                </div>
            </div>
        </div>

        <!-- Active Rule Details -->
        <div class="card" id="active-rule-card" style="display: none;">
            <h3>[RULES] Active Rule Details</h3>
            <div id="active-rule-details">Loading...</div>
            <div style="text-align: center; margin-top: 15px;">
                <a href="/rules.html" class="btn btn-primary">[RULES] Manage Rules</a>
            </div>
        </div>
    </div>

    <script>
        let systemData = {};
        
        // Load system data
        async function loadSystemData() {
            try {
                const response = await fetch('/api/system');
                if (response.ok) {
                    systemData = await response.json();
                    updateDashboard();
                }
            } catch (error) {
                console.error('Error loading system data:', error);
            }
        }
        
        // Load active rule data
        async function loadActiveRule() {
            try {
                const response = await fetch('/api/rules/active');
                if (response.ok) {
                    const data = await response.json();
                    updateActiveRuleDisplay(data);
                }
            } catch (error) {
                console.error('Error loading active rule:', error);
            }
        }
        
        function updateDashboard() {
            // Update temperature
            if (systemData.currentTemp !== undefined) {
                document.getElementById('temp-display').textContent = systemData.currentTemp.toFixed(1) + '°C';
            }
            
            // Update AC status
            if (systemData.acOn !== undefined) {
                const indicator = document.getElementById('ac-indicator');
                const statusText = document.getElementById('ac-status-text');
                if (systemData.acOn) {
                    indicator.className = 'status-indicator status-on';
                    statusText.textContent = '[ON] Running';
                } else {
                    indicator.className = 'status-indicator status-off';
                    statusText.textContent = '[OFF] Stopped';
                }
            }
            
            // Update system info
            if (systemData.system) {
                const sys = systemData.system;
                document.getElementById('free-memory').textContent = Math.round(sys.freeHeap / 1024) + ' KB';
                document.getElementById('uptime').textContent = Math.floor(sys.uptime / 1000) + ' seconds';
                document.getElementById('active-tasks').textContent = sys.activeTasks;
            }
            
            // Update current time
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString();
        }
        
        function updateActiveRuleDisplay(data) {
            const activeRuleCard = document.getElementById('active-rule-card');
            const activeRuleName = document.getElementById('active-rule-name');
            const activeRuleDetails = document.getElementById('active-rule-details');
            
            if (data.activeRuleId && data.activeRuleId !== -1 && data.activeRule) {
                const rule = data.activeRule;
                activeRuleName.textContent = rule.name + ' (ID: ' + rule.id + ')';
                
                let detailsHtml = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">`;
                detailsHtml += `<div><strong>[AC] Power:</strong> ${rule.acOn ? '[ON] ON' : '[OFF] OFF'}</div>`;
                if (rule.acOn) {
                    detailsHtml += `<div><strong>[TEMP] Target:</strong> ${rule.setTemp}°C</div>`;
                    detailsHtml += `<div><strong>[FAN] Fan Speed:</strong> ${['Auto', 'Low', 'Medium', 'High'][rule.fanSpeed]}</div>`;
                    detailsHtml += `<div><strong>[MODE] Mode:</strong> ${['Cool', 'Heat', 'Dry', 'Fan', 'Auto'][rule.mode]}</div>`;
                }
                detailsHtml += `</div>`;
                
                activeRuleDetails.innerHTML = detailsHtml;
                activeRuleCard.style.display = 'block';
            } else {
                activeRuleName.textContent = 'None';
                activeRuleCard.style.display = 'none';
            }
        }
        
        // Send AC command
        function sendACCommand(action) {
            fetch('/api/ac/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'action=' + action
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('[OK] ' + data.message, 'success');
                    setTimeout(loadSystemData, 1000); // Refresh data after command
                } else {
                    showNotification('[ERROR] ' + data.message, 'error');
                }
            })
            .catch(error => {
                showNotification('[ERROR] Connection failed', 'error');
            });
        }
        
        // Show notification
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1000;
                padding: 15px 25px; border-radius: 8px; color: white; font-weight: bold;
                background: ${type === 'success' ? '#28a745' : '#dc3545'};
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transform: translateX(100%); transition: transform 0.3s;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            
            // Hide notification
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }
        
        // Initialize dashboard
        window.onload = function() {
            loadSystemData();
            loadActiveRule();
            
            // Update every 5 seconds
            setInterval(loadSystemData, 5000);
            setInterval(loadActiveRule, 10000);
            
            // Update time every second
            setInterval(() => {
                const now = new Date();
                document.getElementById('current-time').textContent = now.toLocaleTimeString();
            }, 1000);
        };
    </script>
</body>
</html>
